name: Quality Validation

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Check if quality-relevant files were changed
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      code-changed: ${{ steps.filter.outputs.code }}
      docs-changed: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '**/*.py'
              - 'pyproject.toml'
              - 'uv.lock'
              - 'requirements*.txt'
              - 'setup.py'
              - 'setup.cfg'
              - '.pre-commit-config.yaml'
              - 'bin/**'
              - 'tests/**'
            docs:
              - 'docs/**'
              - 'mkdocs.yml'
              - 'packages/*/src/**/*.py'
              - '.github/workflows/docs.yml'

  validate-quality-artifacts:
    runs-on: ubuntu-latest
    name: Validate Quality Checks
    needs: check-changes
    if: needs.check-changes.outputs.code-changed == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true

    - name: Validate package references
      run: |
        echo "üîç Validating package references..."
        uv run python bin/validate-package-references.py

    - name: Validate quality artifacts
      run: |
        echo "üîç Validating quality check artifacts..."
        ./bin/validate-quality-artifacts.sh
    
    - name: Upload validation results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quality-artifacts
        path: .quality-artifacts/
        retention-days: 7
    
    - name: Comment on PR
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          if (context.issue && context.issue.number) {
            const [owner, repo] = context.payload.repository.full_name.split('/');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: owner,
              repo: repo,
            body: `## ‚ùå Quality Check Validation Failed

            The quality check artifacts are either missing, outdated, or show failing tests.

            **Please run the following command locally before pushing:**
            \`\`\`bash
            ./bin/run-quality-checks.sh
            \`\`\`

            This will:
            1. Start the required Docker services (PostgreSQL, Elasticsearch, LocalStack)
            2. Run all unit and integration tests
            3. Perform style checks with ruff
            4. Generate coverage reports
            5. Create artifacts in \`.quality-artifacts/\` that must be committed

            For more information, see [Quality Checks Guide](../blob/main/docs/development/quality-checks.md)`
            })
          }
    
    - name: Set PR status check
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}' === 'success' ? 'success' : 'failure';
          const description = status === 'success' 
            ? 'Quality checks passed locally' 
            : 'Quality checks need to be run locally';
          
          if (context.payload.pull_request && context.payload.pull_request.head) {
            const [owner, repo] = context.payload.repository.full_name.split('/');
            github.rest.repos.createCommitStatus({
              owner: owner,
              repo: repo,
              sha: context.payload.pull_request.head.sha,
              state: status,
              target_url: `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`,
              description: description,
              context: 'quality-checks/validation'
            })
          } else {
            console.log('Skipping status check - not a pull request event or PR data not available');
          }

  build-docs:
    runs-on: ubuntu-latest
    name: Build Documentation
    needs: check-changes
    if: needs.check-changes.outputs.docs-changed == 'true'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git revision date plugin
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        enable-cache: true
        version: "latest"
    
    - name: Install dependencies
      run: |
        uv pip install --system mkdocs mkdocs-material mkdocstrings[python] \
          mkdocs-monorepo-plugin mkdocs-awesome-pages-plugin \
          mkdocs-git-revision-date-localized-plugin
        uv pip install --system -e packages/common
        uv pip install --system -e packages/config
        uv pip install --system -e packages/data
        uv pip install --system -e packages/fsm
        uv pip install --system -e packages/llm
        uv pip install --system -e packages/structures
        uv pip install --system -e packages/utils
        uv pip install --system -e packages/xization
        uv pip install --system -e packages/bots
    
    - name: Build documentation
      run: mkdocs build --strict
      env:
        NO_MKDOCS_2_WARNING: "1"
    
    - name: Upload documentation artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: documentation-build
        path: ./site/
        retention-days: 7

  quick-unit-tests:
    runs-on: ubuntu-latest
    name: Quick Unit Tests (Optional)
    needs: check-changes
    if: needs.check-changes.outputs.code-changed == 'true'
    continue-on-error: true  # Don't block PR if this fails
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync --all-packages
    
    - name: Run quick unit tests
      run: |
        echo "üöÄ Running quick unit tests (no external services)..."
        bin/dk testquick
    
    - name: Add PR comment with test status
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const testResult = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
          const message = testResult === '‚úÖ' 
            ? 'Quick unit tests passed in CI' 
            : 'Quick unit tests had issues (non-blocking)';
          
          // Only comment if tests failed, to reduce noise
          if (testResult === '‚ö†Ô∏è' && context.issue && context.issue.number) {
            const [owner, repo] = context.payload.repository.full_name.split('/');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: owner,
              repo: repo,
              body: `## ${testResult} CI Unit Tests (Optional)

              ${message}

              Note: This is an optional check. The required quality validation checks the locally-run test results.`
            })
          }

  # Summary job that always runs to provide a consistent PR check
  all-checks-complete:
    runs-on: ubuntu-latest
    name: All Checks Complete
    needs: [check-changes, validate-quality-artifacts, build-docs]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "Checking results of all jobs..."
          echo "Code changed: ${{ needs.check-changes.outputs.code-changed }}"
          echo "Docs changed: ${{ needs.check-changes.outputs.docs-changed }}"
          echo "Quality validation: ${{ needs.validate-quality-artifacts.result }}"
          echo "Build docs: ${{ needs.build-docs.result }}"

          # Fail if any required job failed (not skipped)
          if [[ "${{ needs.validate-quality-artifacts.result }}" == "failure" ]]; then
            echo "‚ùå Quality validation failed"
            exit 1
          fi

          if [[ "${{ needs.build-docs.result }}" == "failure" ]]; then
            echo "‚ùå Documentation build failed"
            exit 1
          fi

          # Check if any checks ran
          if [[ "${{ needs.check-changes.outputs.code-changed }}" == "true" ]] || [[ "${{ needs.check-changes.outputs.docs-changed }}" == "true" ]]; then
            echo "‚úÖ All required checks passed"
          else
            echo "‚ÑπÔ∏è  No code or documentation changes detected - skipping quality checks"
          fi
