name: Documentation Version Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'packages/*/pyproject.toml'
      - '.dataknobs/packages.json'
      - 'docs/index.md'
      - 'docs/installation.md'

jobs:
  check-versions:
    runs-on: ubuntu-latest
    name: Verify Documentation Versions

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Check documentation versions
      run: |
        echo "üîç Checking if documentation versions match packages.json..."
        bin/docs-update-versions.sh --check

    - name: Comment on PR if out of sync
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          if (context.issue && context.issue.number) {
            const [owner, repo] = context.payload.repository.full_name.split('/');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: owner,
              repo: repo,
              body: `## ‚ùå Documentation Version Mismatch

          Documentation version references are out of sync with \`.dataknobs/packages.json\`.

          Files checked:
          - \`docs/index.md\` - Version table
          - \`docs/installation.md\` - Requirements example

          **To fix this, run:**
          \`\`\`bash
          bin/docs-update-versions.sh
          \`\`\`

          This will update the documentation with the correct package versions.

          Note: This should happen automatically during the release process via \`bin/release-helper.sh bump\`.`
            })
          }
