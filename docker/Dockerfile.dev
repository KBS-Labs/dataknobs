# BASE: image that other versions are built upon; only include things common to all versions
FROM python:3

# Install necessary system packages and clean-up
RUN chmod 1777 /tmp \
  && apt-get update && apt-get install -y --allow-unauthenticated --no-install-recommends  \
      curl build-essential python3-dev \
      gfortran cmake libopenblas-dev \
      graphviz nmap emacs-nox \
      nodejs npm \
      # Add utilities for service health checks
      jq netcat-openbsd postgresql-client \
      # Add ping for network connectivity tests
      iputils-ping \
  && apt-get clean \
  && rm -rf /var/tmp /tmp /var/lib/apt/lists/* \
  && mkdir -p /var/tmp /tmp

# Install jupyter (python3)
RUN pip install jupyterlab ipywidgets jupyterlab_widgets

# Install uv and tox
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.cargo/bin:${PATH}"
RUN pip3 install tox

# Install ruff
RUN curl -LsSf https://astral.sh/ruff/install.sh | sh

# Install development tools with mypy and type stubs
RUN pip install --no-cache-dir \
    mypy>=1.8.0 \
    pytest>=7.4.0 \
    pytest-cov>=4.1.0 \
    pytest-mock>=3.12.0 \
    # Type stubs for common dependencies
    types-requests \
    types-beautifulsoup4 \
    types-psycopg2 \
    pandas-stubs \
    # Additional type checking tools
    pyright

# Create mypy cache directory
RUN mkdir -p /.mypy_cache && chmod 777 /.mypy_cache

# used as a volume (connects to the host machine's disk at runtime)
RUN mkdir -p /data

WORKDIR /workdir
